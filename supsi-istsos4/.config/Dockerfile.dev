ARG grafana_version=11.5.3
ARG grafana_image=grafana-enterprise

# Development stage - Complete development environment
FROM grafana/${grafana_image}:${grafana_version} AS development

USER root

# Install development dependencies
RUN if grep -i -q alpine /etc/issue; then \
    apk add --no-cache \
    nodejs \
    npm \
    git \
    bash \
    curl \
    inotify-tools \
    supervisor \
    su-exec; \
    elif grep -i -q ubuntu /etc/issue; then \
    DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install -y \
    nodejs \
    npm \
    git \
    bash \
    curl \
    inotify-tools \
    supervisor && \
    rm -rf /var/lib/apt/lists/*; \
    else \
    echo 'ERROR: Unsupported base image' && /bin/false; \
    fi

# Create plugin directory and set permissions
RUN mkdir -p /plugin && \
    chown -R 472:0 /plugin

# Install live reload script injection
RUN sed -i 's|</body>|<script src="http://localhost:35729/livereload.js"></script></body>|g' /usr/share/grafana/public/views/index.html

# Setup supervisord for process management
COPY .config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy development entrypoint
COPY .config/entrypoint-dev.sh /entrypoint-dev.sh
RUN chmod +x /entrypoint-dev.sh

# Copy live reload script
COPY .config/livereload-server.js /usr/local/bin/livereload-server.js
RUN chmod +x /usr/local/bin/livereload-server.js

# Switch to grafana user for runtime
USER 472
WORKDIR /plugin

ENTRYPOINT ["/entrypoint-dev.sh"]
CMD ["/run.sh"]

# Production stage - optimized for production deployment
FROM node:18-alpine AS builder

WORKDIR /plugin

# Copy package files
COPY package*.json ./
COPY yarn.lock* ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Build the plugin
RUN npm run build

# Production runtime
FROM grafana/${grafana_image}:${grafana_version} AS production

USER root

# Copy built plugin
COPY --from=builder /plugin/dist /var/lib/grafana/plugins/supsi-istsos4

# Set proper permissions
RUN chown -R 472:0 /var/lib/grafana/plugins/supsi-istsos4

USER 472
